<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üå± Smart Agriculture Dashboard</title>
<style>
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: "Segoe UI", Arial, sans-serif;
    background: #eaf5ec;
    color: #1f2e1f;
  }
  .page-wrap {
    min-height: 100vh;
    background: radial-gradient(circle at 20% 20%, rgba(76, 201, 122, 0.25), transparent 45%),
                radial-gradient(circle at 80% 0%, rgba(118, 199, 240, 0.25), transparent 40%),
                linear-gradient(145deg, #fcfff7 0%, #eaf7ef 60%, #f0fbff 100%);
    padding-bottom: 60px;
  }
  .hero {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 30px;
    padding: 60px 10%;
    background: linear-gradient(130deg, #1f8a3e 0%, #5cd07c 60%, #61d8c9 100%);
    color: white;
    border-bottom-left-radius: 45px;
    border-bottom-right-radius: 45px;
    box-shadow: 0 25px 45px rgba(31, 138, 62, 0.35);
  }
  .hero-content {
    flex: 1 1 420px;
  }
  .hero-content h1 {
    font-size: 3rem;
    margin: 10px 0 15px;
    line-height: 1.2;
  }
  .hero-subtitle {
    color: rgba(255, 255, 255, 0.85);
    font-size: 1.1rem;
    max-width: 520px;
  }
  .eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.35em;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.82);
  }
  .hero-stats {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-top: 25px;
  }
  .stat-card {
    flex: 1 1 140px;
    min-width: 140px;
    background: rgba(255, 255, 255, 0.18);
    border: 1px solid rgba(255, 255, 255, 0.35);
    border-radius: 18px;
    padding: 16px 18px;
  }
  .stat-value {
    font-size: 1.4rem;
    font-weight: 700;
    display: block;
  }
  .stat-label {
    font-size: 0.9rem;
    opacity: 0.85;
  }
  .hero-actions {
    margin-top: 30px;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }
  .hero-card {
    flex: 0 0 320px;
    background: rgba(255, 255, 255, 0.18);
    border-radius: 26px;
    padding: 28px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(8px);
  }
  .hero-card h3 {
    margin-top: 0;
  }
  .hero-card p {
    color: rgba(255, 255, 255, 0.92);
    line-height: 1.5;
  }
  .hero-card button {
    width: 100%;
    margin-top: 20px;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 60px 30px;
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.92);
    border-radius: 30px;
    padding: 40px;
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.7);
  }
  .section-title {
    text-align: center;
    color: #1f8a3e;
    font-size: 2rem;
    margin-bottom: 10px;
  }
  .section-subtitle {
    text-align: center;
    max-width: 720px;
    margin: 0 auto 35px;
    color: #5a6b5a;
  }
  .feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 24px;
  }
  .feature-card {
    background: linear-gradient(150deg, #ffffff, #f4fff6);
    border: 1px solid rgba(43, 122, 43, 0.15);
    border-radius: 24px;
    padding: 24px;
    box-shadow: 0 12px 30px rgba(43, 122, 43, 0.08);
    text-align: left;
  }
  .feature-card h3 {
    margin: 0 0 10px;
    color: #1f2e1f;
  }
  .feature-card p {
    margin: 0 0 18px;
    color: #4a604a;
  }
  .pill {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 999px;
    background: rgba(43, 122, 43, 0.15);
    color: #1f8a3e;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 12px;
  }
  .pill-btn {
    border: none;
    background: none;
    color: #1f8a3e;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  input[type="text"],
  input[type="file"],
  select {
    padding: 10px 14px;
    width: 100%;
    max-width: 420px;
    margin-bottom: 12px;
    border-radius: 10px;
    border: 1px solid #d4e1d4;
    font-size: 0.95rem;
  }
  .upload-section {
    display: none;
    margin-top: 20px;
  }
  #liveCameraSection {
    margin-top: 20px;
    text-align: center;
  }
  #liveCameraSection img {
    border: 4px solid rgba(43, 122, 43, 0.35);
    border-radius: 18px;
    background: black;
    width: min(95vw, 820px);
    max-width: 100%;
    height: auto;
    aspect-ratio: 4 / 3;
    box-shadow: 0 20px 45px rgba(0, 0, 0, 0.25);
  }
  .action-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 25px;
  }
  .primary-btn,
  .secondary-btn {
    padding: 14px 28px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .primary-btn {
    background: linear-gradient(120deg, #2b7a2b, #49b649);
    color: white;
    box-shadow: 0 12px 24px rgba(43, 122, 43, 0.3);
  }
  .secondary-btn {
    background: transparent;
    color: #1f8a3e;
    border: 2px solid rgba(31, 138, 62, 0.4);
  }
  .primary-btn:hover,
  .secondary-btn:hover {
    transform: translateY(-2px);
  }
  .primary-btn.ghost,
  .secondary-btn.ghost {
    border-color: rgba(255, 255, 255, 0.6);
    color: #fff;
  }
  .primary-btn.ghost {
    background: rgba(255, 255, 255, 0.15);
    box-shadow: none;
  }
  .secondary-btn.ghost {
    background: transparent;
  }
  .output-image {
    max-width: 100%;
    max-height: 480px;
    border: 3px solid #2b7a2b;
    border-radius: 16px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    transition: transform 0.3s ease;
  }
  .output-image:hover {
    transform: scale(1.02);
  }
  .result {
    display: none;
  }
  .result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 20px;
  }
  .result-card {
    background: white;
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 12px 25px rgba(0, 0, 0, 0.08);
  }
  .weather-panel {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-bottom: 15px;
  }
  .weather-panel input {
    flex: 1;
    min-width: 260px;
  }
  .weather-cards {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    margin-top: 15px;
  }
  .weather-card {
    background: white;
    border-radius: 20px;
    padding: 24px;
    width: 220px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
    text-align: center;
  }
  .weather-card .probability {
    font-size: 42px;
    font-weight: bold;
    margin: 15px 0 5px;
    color: #1d4f1d;
  }
  .weather-status {
    color: #4b5d4b;
    font-style: italic;
    text-align: center;
  }
  .highlight {
    font-weight: bold;
    color: #2b7a2b;
    font-size: 1.3rem;
  }
  @media (max-width: 960px) {
    .hero {
      padding: 50px 8% 60px;
    }
    .hero-content h1 {
      font-size: 2.3rem;
    }
    .hero-card {
      flex: 1 1 100%;
    }
  }
  @media (max-width: 640px) {
    .container {
      padding: 40px 20px;
    }
    .glass-card {
      padding: 28px;
    }
    .hero {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
  }
</style>
</head>
<body>

<div class="page-wrap">

<header class="hero" id="home">
  <div class="hero-content">
    <p class="eyebrow">AI + WEATHER COPILOT</p>
    <h1>Precision farming decisions in seconds</h1>
    <p class="hero-subtitle">
      Upload a single frame or tap into your live feed to diagnose leaf health, gauge irrigation urgency,
      and blend those insights with hyper-local rainfall forecasts.
    </p>
    <div class="hero-stats">
      <div class="stat-card">
        <span class="stat-value">üçÉCheck Nutrient deficiency</span>
        <!-- <span class="stat-label">Leaf health classes</span> -->
      </div>
      <div class="stat-card">
        <span class="stat-value">üíß Water need suggestions</span>
        <!-- <span class="stat-label">Water need suggestions</span> -->
      </div>
      <div class="stat-card">
        <span class="stat-value">üåß 48h Rain forecast</span>
        <!-- <span class="stat-label">Rain tracking window</span> -->
      </div>
    </div>
    <div class="hero-actions">
      <button class="primary-btn" onclick="showUpload('nutrient-deficiency')">Start nutrient scan</button>
      <button class="secondary-btn" onclick="showUpload('irrigation-necessity')">Check irrigation</button>
      <button class="secondary-btn ghost" onclick="document.getElementById('weather').scrollIntoView({ behavior: 'smooth' });">Weather outlook</button>
    </div>
  </div>
  <div class="hero-card">
    <h3>Live Weather Pulse</h3>
    <p id="heroWeather">Enter a location below to sync forecast data.</p>
    <button class="primary-btn ghost" onclick="document.getElementById('weather').scrollIntoView({ behavior: 'smooth' });">Update forecast</button>
  </div>
</header>

<section class="container" id="features">
  <div class="glass-card">
    <h2 class="section-title">Intelligent modules</h2>
    <p class="section-subtitle">
      Seamlessly switch between nutrient deficiency detection, irrigation advisory, and weather intelligence for faster field decisions.
    </p>
    <div class="feature-grid">
      <div class="feature-card">
        <span class="pill">üçÉ Nutrient AI</span>
        <h3>Leaf deficiency detection</h3>
        <p>Run your custom TensorFlow classifier on any captured frame to identify dead, healthy, or unhealthy leaves with confidence overlays.</p>
        <button class="pill-btn" onclick="showUpload('nutrient-deficiency')">Run scan ‚Üí</button>
      </div>
      <div class="feature-card">
        <span class="pill">üíß Irrigation Brain</span>
        <h3>Water need estimation</h3>
        <p>Combine soil brightness heuristics with leaf stress predictions to calculate mm of irrigation required for each crop/method combo.</p>
        <button class="pill-btn" onclick="showUpload('irrigation-necessity')">Run scan ‚Üí</button>
      </div>
      <div class="feature-card">
        <span class="pill">üå¶ Weather Sync</span>
        <h3>48-hour rain pulse</h3>
        <p>Pull OpenWeatherMap forecasts directly into the dashboard and overlay today vs tomorrow rain probabilities on your decisions.</p>
        <button class="pill-btn" onclick="document.getElementById('weather').scrollIntoView({ behavior: 'smooth' });">View forecast ‚Üí</button>
      </div>
    </div>
  </div>
</section>

<div class="container glass-card upload-section" id="uploadSection">
  <h2 id="uploadTitle">Upload Image or Capture Live Frame</h2>

  <!-- upload image -->
  <input type="file" id="imageInput" accept="image/*" />

  <!-- irrigation extra inputs -->
  <!-- <div id="irrigationInputs" style="display:none; margin-top:15px;">
    <select id="cropType">
      <option value="potato" selected>Potato</option>
      <option value="tomato">Tomato</option>
      <option value="wheat">Wheat</option>
      <option value="rice">Rice</option>
      <option value="maize">Maize</option>
      <option value="cotton">Cotton</option>
      <option value="soybean">Soybean</option>
      <option value="groundnut">Groundnut</option>
      <option value="sugarcane">Sugarcane</option>
      <option value="custom">Other (type below)</option>
    </select>
    <input type="text" id="customCrop" placeholder="Type crop name when selecting Other" style="display:none;" />
    <input type="text" id="irrigationMethod" placeholder="Enter method (e.g., flood, drip)" />
  </div> -->
<!-- Irrigation extra inputs -->
<div id="irrigationInputs" style="display:none; margin-top:15px;">
  <select id="cropType">
    <option value="potato" selected>Potato</option>
    <option value="tomato">Tomato</option>
    <option value="wheat">Wheat</option>
    <option value="rice">Rice</option>
    <option value="maize">Maize</option>
    <option value="cotton">Cotton</option>
    <option value="soybean">Soybean</option>
    <option value="groundnut">Groundnut</option>
    <option value="sugarcane">Sugarcane</option>
    <!-- <option value="custom">Other (type below)</option> -->
  </select>
  <!-- <input type="text" id="customCrop" placeholder="Type crop name when selecting Other" style="display:none;" /> -->

  <!-- Replace text input with dropdown for irrigation method -->
  <select id="irrigationMethod">
    <option value="flood">Flood</option>
    <option value="drip">Drip</option>
    <option value="sprinkler">Sprinkler</option>
    <option value="furrow">Furrow</option>
    <option value="manual">Manual</option>
    <!-- <option value="custom">Other (type below)</option> -->
  </select>
  <!-- <input type="text" id="customIrrigation" placeholder="Type method when selecting Other" style="display:none;" /> -->
</div>

  <!-- live feed -->
  <div id="liveCameraSection" style="margin-top:20px;">
    <h3>üì∏ Live Camera Feed</h3>
    <img id="liveVideo"
      src="http://192.168.1.21:8080/video"
      width="640" height="480"
      alt="Live camera feed">
    <p id="videoStatus" style="color:green; margin-top:10px;">
      Auto capturing every 5 seconds...
    </p>
  </div>

  <div class="action-buttons">
    <button id="submitBtn" class="primary-btn" onclick="uploadImage()">Analyze Now</button>
    <button class="secondary-btn" onclick="uploadImage(true)">Capture Current Frame</button>
  </div>
</div>

<!-- <button onclick="uploadImage()" id="submitBtn">Submit</button> -->

<div id="loadingIndicator" style="display:none; margin-top:20px;">
  <div style="text-align:center;">
    <div style="border:4px solid #f3f3f3; border-top:4px solid #2b7a2b;
                border-radius:50%; width:40px; height:40px;
                animation:spin 1s linear infinite; margin:0 auto;"></div>
    <p style="margin-top:10px; color:#2b7a2b; font-weight:bold;">
      Processing your image...
    </p>
  </div>
</div>

<div class="container glass-card result" id="resultBox">
  <h2 class="section-title">Live results</h2>
  <div id="prediction" class="result-grid"></div>
</div>

<div class="container glass-card" id="weather">
  <h2 class="section-title">Weather intelligence</h2>
  <p class="section-subtitle">
    Blend local AI insights with live forecasts. Enter any city to track rain probability for the next 48 hours.
  </p>
  <div class="weather-panel">
    <input type="text" id="weatherLocation" placeholder="City,CountryCode (e.g., Chennai,IN)" />
    <button class="primary-btn" onclick="fetchWeather()">Update Forecast</button>
  </div>
  <p id="weatherStatus" class="weather-status">Awaiting location...</p>
  <div class="weather-cards" id="weatherCards">
    <div class="weather-card">
      <h3>Today</h3>
      <p class="probability" id="todayRain">--%</p>
      <small>Rain probability</small>
    </div>
    <div class="weather-card">
      <h3>Tomorrow</h3>
      <p class="probability" id="tomorrowRain">--%</p>
      <small>Rain probability</small>
    </div>
  </div>
</div>

</div> <!-- page-wrap -->

<script>
const API_BASE = "http://127.0.0.1:8000";
const WEATHER_REFRESH_MS = 15 * 60 * 1000;
let currentTask = "";
let isCapturing = false;
let autoCaptureInterval = null;
let weatherInterval = null;

function handleCropSelection() {
  const cropSelect = document.getElementById("cropType");
  const customInput = document.getElementById("customCrop");
  if (!cropSelect || !customInput) return;
  const isCustom = cropSelect.value === "custom";
  customInput.style.display = isCustom ? "block" : "none";
  if (!isCustom) {
    customInput.value = "";
  } else {
    customInput.focus();
  }
}

function initCropSelect() {
  const cropSelect = document.getElementById("cropType");
  if (cropSelect) {
    cropSelect.addEventListener("change", handleCropSelection);
    handleCropSelection();
  }
}

function showUpload(task) {
  currentTask = task;
  document.getElementById("uploadSection").style.display = "block";
  document.getElementById("uploadTitle").innerText =
    "Upload an image or use live feed for: " + task.replace("-", " ");
  document.getElementById("irrigationInputs").style.display =
    task === "irrigation-necessity" ? "block" : "none";
  document.getElementById("resultBox").style.display = "none";

  // clear any previous auto capture interval
  if (autoCaptureInterval) clearInterval(autoCaptureInterval);

  // start automatic capture every 5 seconds
  autoCaptureInterval = setInterval(() => {
    if (!isCapturing) {
      console.log("Auto-capturing frame for:", currentTask);
      uploadImage(true); // true = auto mode
    }
  }, 5000); // delay (ms)
}

// stop auto-capture when leaving page
window.addEventListener("beforeunload", () => {
  if (autoCaptureInterval) clearInterval(autoCaptureInterval);
  if (weatherInterval) clearInterval(weatherInterval);
});

async function uploadImage(isAuto = false) {
  if (isCapturing) return; // prevent overlap
  isCapturing = true;

  try {
    let fileInputElement = document.getElementById("imageInput");
    let fileBlob = fileInputElement.files[0] || null;

    // if no file, get live frame from backend proxy
    if (!fileBlob) {
      const frameResponse = await fetch("http://127.0.0.1:8000/get_frame");
      if (!frameResponse.ok) {
        console.warn("Failed to get frame from backend!");
        isCapturing = false;
        return;
      }
      fileBlob = await frameResponse.blob();
    }

    if (!fileBlob) {
      console.warn("No frame or file available");
      isCapturing = false;
      return;
    }

    const submitBtn = document.getElementById("submitBtn");
    if (!isAuto) {
      document.getElementById("loadingIndicator").style.display = "block";
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerText = "Processing...";
      }
    }

    const formData = new FormData();
    formData.append("file", fileBlob, "frame.jpg");

    const cropSelect = document.getElementById("cropType");
    const customCropInput = document.getElementById("customCrop");
    let cropType = cropSelect?.value.trim().toLowerCase() || "potato";
    if (cropType === "custom") {
      cropType = customCropInput?.value.trim().toLowerCase() || "custom";
    }
    const irrigationMethod = document.getElementById("irrigationMethod")?.value.trim().toLowerCase() || "flood";

    let endpoint = "";
    if (currentTask === "nutrient-deficiency") endpoint = "detect-nutrient-deficiency";
    if (currentTask === "irrigation-necessity") endpoint = "check-irrigation";

    let url = `${API_BASE}/${endpoint}`;
    if (currentTask === "irrigation-necessity") {
      url += `?crop_type=${cropType}&irrigation_method=${irrigationMethod}`;
    }

    const response = await fetch(url, { method: "POST", body: formData });
    const data = await response.json();

    if (!data) return;

    document.getElementById("resultBox").style.display = "block";
    let html = "";

    if (endpoint === "detect-nutrient-deficiency") {
      html = `
        <div class="result-card">
          <h3>üçÉ Nutrient Deficiency Analysis</h3>
          <p><b>Prediction:</b> ${data.prediction}</p>
          <p><b>Confidence:</b> ${data.confidence}</p>
          ${data.output_image ? `<div style="margin-top:20px; text-align:center;">
            <img src="${data.output_image}" class="output-image" alt="Annotated"></div>` : ""}
        </div>
      `;
    } else if (endpoint === "check-irrigation") {
      html = `
        <div class="result-card">
          <h3>üíß Irrigation Recommendation</h3>
          <p><b>Leaf Status:</b> ${data.leaf_status}</p>
          <p><b>Soil Status:</b> ${data.soil_status}</p>
          <p><b>Crop:</b> ${data.crop}</p>
          <p><b>Method:</b> ${data.irrigation_method}</p>
          <p><b>Water Needed:</b> <span class="highlight">${data.water_needed_mm} mm</span></p>
          ${data.output_image ? `<div style="margin-top:20px; text-align:center;">
            <img src="${data.output_image}" class="output-image" alt="Annotated"></div>` : ""}
        </div>
      `;
    } else {
      html = `<div class="result-card"><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
    }

    // Display the latest result
    document.getElementById("prediction").innerHTML = html;

  } catch (error) {
    console.error("Error:", error);
  } finally {
    isCapturing = false;
    document.getElementById("loadingIndicator").style.display = "none";
    const submitBtn = document.getElementById("submitBtn");
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerText = "Analyze Now";
    }
  }
}

async function fetchWeather(isAuto = false) {
  const locationInput = document.getElementById("weatherLocation");
  const statusEl = document.getElementById("weatherStatus");
  if (!locationInput || !statusEl) return;

  const location = locationInput.value.trim() || "Chennai,IN";
  if (!isAuto) {
    statusEl.textContent = "Fetching forecast...";
  }

  try {
    const response = await fetch(`${API_BASE}/weather?location=${encodeURIComponent(location)}`);
    const data = await response.json();
    if (!response.ok || data.error) {
      throw new Error(data.error || "Unable to fetch forecast");
    }

    document.getElementById("todayRain").innerText = `${data.today_rain_probability}%`;
    document.getElementById("tomorrowRain").innerText = `${data.tomorrow_rain_probability}%`;
    statusEl.textContent = `Updated ${new Date().toLocaleTimeString()} for ${data.location}`;
    const heroWeather = document.getElementById("heroWeather");
    if (heroWeather) {
      heroWeather.textContent = `Today ${data.today_rain_probability}% ‚Ä¢ Tomorrow ${data.tomorrow_rain_probability}% chance of rain for ${data.location}.`;
    }

  } catch (error) {
    statusEl.textContent = `Weather error: ${error.message}`;
    const heroWeather = document.getElementById("heroWeather");
    if (heroWeather) {
      heroWeather.textContent = "Weather fetch failed. Try updating the forecast again.";
    }
  }
}

function initWeatherSection() {
  const locationInput = document.getElementById("weatherLocation");
  if (locationInput && !locationInput.value) {
    locationInput.value = "Chennai,IN";
  }
  fetchWeather();
  if (weatherInterval) clearInterval(weatherInterval);
  weatherInterval = setInterval(() => fetchWeather(true), WEATHER_REFRESH_MS);
}

// Init weather section once DOM is ready (script placed at bottom)
initCropSelect();
initWeatherSection();
</script>
</body>
</html>
